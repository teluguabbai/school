{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>School Admin Console</title>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        /* Google/Material Design Color Palette */
        :root {
            --google-blue: #1a73e8; /* Primary action color */
            --google-dark-gray: #202124; /* Title text */
            --google-light-gray: #f8f9fa; /* Background */
            --google-card-bg: #ffffff; /* Card background */
            --google-success: #34a853;
            --google-warning: #fbbc05;
            --google-danger: #ea4335;
        }

        /* General Body and Font */
        body {
            background-color: var(--google-light-gray);
            font-family: 'Roboto', sans-serif;
            color: #3c4043;
            padding: 0; /* Remove body padding, contained in container */
        }

        /* Top Bar/Navbar - Clean and Distinct */
        .navbar {
            background-color: var(--google-card-bg) !important;
            border-bottom: 1px solid #e0e0e0;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
            padding: 12px 25px;
        }
        .navbar-brand {
            font-weight: 700;
            font-size: 1.4rem;
            color: var(--google-blue) !important;
            display: flex;
            align-items: center;
        }

        /* Main Content Area */
        .container-xl {
            max-width: 1400px;
            padding-top: 40px;
            padding-bottom: 40px;
        }

        /* Titles */
        .main-title {
            font-weight: 700;
            color: var(--google-dark-gray);
            margin-bottom: 40px;
            font-size: 2.5rem;
        }
        .section-header {
            font-weight: 500;
            color: var(--google-dark-gray);
            padding-bottom: 8px;
            border-bottom: 2px solid #e0e0e0;
            margin-top: 40px;
            margin-bottom: 25px;
            font-size: 1.6rem;
        }

        /* Cards - Material Look */
        .card-material {
            background: var(--google-card-bg);
            border-radius: 8px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1), 0 1px 2px rgba(0, 0, 0, 0.06); /* Soft, subtle shadow */
            border: none; /* Remove default bootstrap border */
            padding: 25px;
            margin-bottom: 40px;
        }
        
        /* Tables - Optimized for Data */
        .table-responsive {
            border: 1px solid #e0e0e0;
            border-radius: 6px;
            overflow: hidden;
        }
        .table {
            margin-bottom: 0;
            font-size: 0.9rem;
        }
        .table thead th {
            background-color: #e8eaed !important; /* Light Gray Header */
            color: #5f6368;
            font-weight: 500;
            border: none;
            padding: 12px 15px;
        }
        .table tbody tr:hover {
            background-color: #f7f9fa; /* Subtle row hover */
        }
        .low-attendance {
            background-color: #fce8e6 !important; /* Light red background */
            font-weight: 500;
            color: var(--google-danger);
        }

        /* Buttons and CTAs */
        .btn-cta {
            font-weight: 500;
            padding: 8px 18px;
            border-radius: 20px; /* Pill-shaped for modern look */
        }
        .btn-action {
            margin-right: 4px;
            padding: 4px 10px;
            font-size: 0.8rem;
        }
        .btn-outline-action {
             color: var(--google-blue);
             border-color: #e0e0e0;
             background-color: transparent;
        }
        .btn-outline-action:hover {
            background-color: #f0f0f0;
            color: var(--google-blue);
            border-color: #e0e0e0;
        }

        /* Accordion - Clean and Structured */
        .accordion {
            --bs-accordion-border-width: 1px;
            --bs-accordion-border-color: #e0e0e0;
            --bs-accordion-border-radius: 6px;
        }
        .accordion-item {
            margin-bottom: 8px;
            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.05);
        }
        .accordion-button {
            font-weight: 500;
            color: var(--google-dark-gray);
            background-color: var(--google-card-bg);
            padding: 15px 20px;
        }
        .accordion-button:not(.collapsed) {
            color: var(--google-blue);
            background-color: #e6f4ea; /* Light background for active state */
            box-shadow: inset 0 -1px 0 rgba(0, 0, 0, .125);
        }

        /* Inner Accordion for Marks */
        .accordion-body .accordion-item {
            margin-top: 5px;
            margin-bottom: 5px;
        }
        .accordion-body .accordion-button {
            font-size: 0.9rem;
            padding: 10px 15px;
        }
        .mark-exam-header {
            background-color: #e8f0fe !important; /* Light blue header */
            color: var(--google-blue);
            font-weight: 500;
            padding: 8px;
            border-radius: 4px;
            margin-top: 10px;
            margin-bottom: 10px;
            font-size: 0.95rem;
        }
    </style>
</head>
<body>

<nav class="navbar navbar-expand-lg">
    <div class="container-fluid container-xl">
        <a class="navbar-brand" href="#"><i class="fas fa-graduation-cap me-2"></i> Admin Console</a>
        <div class="ms-auto d-flex gap-2 align-items-center">
            <a href="{% url 'user_list' %}" class="btn btn-outline-action btn-sm">User Groups</a>
            <a href="{% url 'dashboard' %}" class="btn btn-outline-action btn-sm">Dashboard</a>
            <a href="{% url 'logout' %}" class="btn btn-danger btn-sm btn-cta">Logout</a>
        </div>
    </div>
</nav>

<div class="container-xl">
    <h1 class="text-center main-title">Administration Panel</h1>

    <div class="card-material">
        <h2 class="section-header">Faculty Management <i class="fas fa-chalkboard-teacher text-muted ms-2"></i></h2>
        <p class="text-muted mb-3">View and manage faculty details and credentials.</p>
        <a href="{% url 'add_faculty' %}" class="btn btn-success btn-cta mb-4">
            <i class="fas fa-plus me-1"></i> Add New Faculty
        </a>

        <div class="table-responsive">
            <table class="table table-striped table-hover align-middle">
                <thead>
                    <tr>
                        <th>Username</th>
                        <th>Full Name</th>
                        <th>Email</th>
                        <th>Department</th>
                        <th>Employee ID</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                {% for faculty in faculty %}
                    <tr>
                        <td>
                            <a href="{% url 'faculty_detail' faculty.id %}" class="text-decoration-none fw-bold text-primary">
                                {{ faculty.user.username }}
                            </a>
                        </td>
                        <td>{{ faculty.user.get_full_name }}</td>
                        <td>{{ faculty.user.email }}</td>
                        <td>{{ faculty.department }}</td>
                        <td>{{ faculty.employee_id }}</td>
                        <td>
                            <a href="{% url 'edit_faculty' faculty.id %}" class="btn btn-outline-warning btn-sm btn-action"><i class="fas fa-edit"></i> Edit</a>
                            <a href="{% url 'delete_faculty' faculty.id %}" class="btn btn-outline-danger btn-sm btn-action"><i class="fas fa-trash-alt"></i> Delete</a>
                        </td>
                    </tr>
                {% empty %}
                    <tr>
                        <td colspan="6" class="text-center py-4 text-secondary">No faculty records found.</td>
                    </tr>
                {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
    
    <hr class="my-5">

    <div class="card-material">
        <h2 class="section-header">Student Management <i class="fas fa-user-graduate text-muted ms-2"></i></h2>
        <p class="text-muted mb-3">Organized by class level. Attendance below 75% is highlighted in red for quick review.</p>
        <a href="{% url 'add_student' %}" class="btn btn-success btn-cta mb-4">
            <i class="fas fa-plus me-1"></i> Add New Student
        </a>

        <div class="accordion" id="studentAccordion">
            {% regroup students by class_level as class_list %}
            {% for class_group in class_list %}
                <div class="accordion-item">
                    <h2 class="accordion-header" id="heading{{ forloop.counter }}">
                        <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" 
                                data-bs-target="#collapse{{ forloop.counter }}" aria-expanded="false" 
                                aria-controls="collapse{{ forloop.counter }}">
                            <span class="fw-bold">Class {{ class_group.grouper }}</span> 
                            <span class="badge bg-secondary ms-3">{{ class_group.list|length }} Students</span>
                        </button>
                    </h2>
                    
                    <div id="collapse{{ forloop.counter }}" class="accordion-collapse collapse" 
                         aria-labelledby="heading{{ forloop.counter }}" data-bs-parent="#studentAccordion">
                        <div class="accordion-body p-3">
                            <div class="table-responsive">
                                <table class="table table-striped table-hover align-middle">
                                    <thead>
                                        <tr>
                                            <th>Username</th>
                                            <th>Full Name</th>
                                            <th>Department</th>
                                            <th>Roll Number</th>
                                            <th>Attendance %</th>
                                            <th>Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                    {% for student in class_group.list %}
                                        <tr class="{% if student.attendance_percentage < 75 %}low-attendance{% endif %}">
                                            <td>{{ student.user.username }}</td>
                                            <td>{{ student.user.get_full_name }}</td>
                                            <td>{{ student.department }}</td>
                                            <td>{{ student.roll_number }}</td>
                                            <td><span class="fw-bold">{{ student.attendance_percentage }}%</span></td>

                                            <td>
                                                <a href="{% url 'edit_student' student.id %}" class="btn btn-outline-warning btn-sm btn-action"><i class="fas fa-edit"></i> Edit</a>
                                                <a href="{% url 'delete_student' student.id %}" class="btn btn-outline-danger btn-sm btn-action"><i class="fas fa-trash-alt"></i> Delete</a>
                                                <a href="{% url 'manage_attendance' student.id %}" class="btn btn-outline-primary btn-sm btn-action"><i class="fas fa-calendar-check"></i> Attendance</a>
                                            </td>
                                        </tr>
                                    {% endfor %}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            {% endfor %}
        </div>
    </div>
    
    <hr class="my-5">

    <div class="card-material">
        <h2 class="section-header">Marks & Exam Management <i class="fas fa-file-alt text-muted ms-2"></i></h2>
        <p class="text-muted mb-3">Drill down into specific student's marks grouped by class and examination type.</p>
        <a href="{% url 'add_marks' %}" class="btn btn-success btn-cta mb-4">
            <i class="fas fa-file-upload me-1"></i> Add New Marks
        </a>

        <div class="accordion" id="marksAccordion">
            {% regroup students by class_level as marks_class_list %}
            {% for class_group in marks_class_list %}
                <div class="accordion-item">
                    <h2 class="accordion-header" id="marksHeading{{ forloop.counter }}">
                        <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" 
                                data-bs-target="#marksCollapse{{ forloop.counter }}" aria-expanded="false" 
                                aria-controls="marksCollapse{{ forloop.counter }}">
                            <span class="fw-bold">Class {{ class_group.grouper }}</span> 
                            <span class="badge bg-secondary ms-3">{{ class_group.list|length }} Students</span>
                        </button>
                    </h2>
                    <div id="marksCollapse{{ forloop.counter }}" class="accordion-collapse collapse" 
                         aria-labelledby="marksHeading{{ forloop.counter }}" data-bs-parent="#marksAccordion">
                        <div class="accordion-body p-3">
                            <div class="accordion" id="studentAccordion{{ forloop.counter }}">
                                {% for student in class_group.list %}
                                    <div class="accordion-item">
                                        <h2 class="accordion-header" id="studentHeading{{ forloop.parentloop.counter }}{{ forloop.counter }}">
                                            <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" 
                                                    data-bs-target="#studentCollapse{{ forloop.parentloop.counter }}{{ forloop.counter }}" 
                                                    aria-expanded="false" 
                                                    aria-controls="studentCollapse{{ forloop.parentloop.counter }}{{ forloop.counter }}">
                                                <span class="fw-bold text-primary">{{ student.user.get_full_name }}</span> (Roll: {{ student.roll_number }})
                                            </button>
                                        </h2>
                                        <div id="studentCollapse{{ forloop.parentloop.counter }}{{ forloop.counter }}" 
                                             class="accordion-collapse collapse" 
                                             aria-labelledby="studentHeading{{ forloop.parentloop.counter }}{{ forloop.counter }}" 
                                             data-bs-parent="#studentAccordion{{ forloop.parentloop.counter }}">

                                            <div class="accordion-body">
                                                {% if student.marks_set.all %}
                                                    {% regroup student.marks_set.all by exam_type as exam_groups %}
                                                    {% for exam_group in exam_groups %}
                                                        <h6 class="mark-exam-header">{{ exam_group.grouper }} Marks</h6>
                                                        <div class="table-responsive">
                                                            <table class="table table-bordered mb-3 table-striped align-middle">
                                                                <thead>
                                                                    <tr>
                                                                        <th>Subject</th>
                                                                        <th>Marks</th>
                                                                        <th>Max Marks</th>
                                                                        <th>Actions</th>
                                                                    </tr>
                                                                </thead>
                                                                <tbody>
                                                                {% for mark in exam_group.list %}
                                                                    <tr>
                                                                        <td>{{ mark.subject }}</td>
                                                                        <td><span class="fw-bold text-success">{{ mark.marks }}</span></td>
                                                                        <td>{{ mark.max_marks }}</td>
                                                                        <td>
                                                                            <a href="{% url 'edit_marks' mark.id %}" class="btn btn-outline-warning btn-sm btn-action">Edit</a>
                                                                            <a href="{% url 'delete_marks' mark.id %}" class="btn btn-outline-danger btn-sm btn-action">Delete</a>
                                                                        </td>
                                                                    </tr>
                                                                {% endfor %}
                                                                </tbody>
                                                            </table>
                                                        </div>
                                                    {% endfor %}
                                                {% else %}
                                                    <p class="alert alert-info p-2 text-center">No marks available for this student.</p>
                                                {% endif %}
                                            </div>
                                        </div>
                                    </div>
                                {% endfor %}
                            </div>
                        </div>
                    </div>
                </div>
            {% endfor %}
        </div>
    </div>
</div>


<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
